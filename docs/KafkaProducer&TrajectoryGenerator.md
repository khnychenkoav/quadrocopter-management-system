# Отчёт о разработке функционала для управления квадрокоптером и отправки данных в Kafka

**Задача:** Разработка системы для управления квадрокоптером с использованием симулятора AirSim и отправки данных о траектории полёта в Kafka.

## Введение

В рамках данного этапа проекта была поставлена задача по разработке системы, которая позволяет управлять квадрокоптером в симуляторе AirSim и отправлять данные о траектории полёта в Kafka. Данная система является важным компонентом для дальнейшей разработки и тестирования алгоритмов управления, а также для проведения исследований в области автономной навигации. Симуляция позволяет проводить испытания в контролируемой виртуальной среде, минимизируя риски и затраты, связанные с реальными полётами. Кроме того, отправка данных в Kafka предоставляет возможность для дальнейшего анализа и обработки данных.

## Описание работы

### Генератор траекторий

Генератор траекторий (`trajectory_generator.py`) отвечает за управление квадрокоптером в симуляторе AirSim и отправку данных о траектории полёта в Kafka. Основные функции включают взлёт, посадку, генерацию траекторий и отправку данных.

Пример кода для взлёта и посадки:
```py
def takeoff(self):
    self.client.takeoffAsync().join()

def land(self):
    self.client.landAsync().join()
    self.client.armDisarm(False)
    self.client.enableApiControl(False)
    self.producer.close()
```
### Обёртка для Kafka Producer
Обёртка для Kafka Producer (`kafka_producer_wrapper.py`) обеспечивает удобный интерфейс для отправки сообщений в Kafka. Она включает методы для отправки сообщений и закрытия соединения

Пример кода для отправки сообщения:
```py
def send_message(self, message):
    try:
        future = self.producer.send(self.topic, message)
        record_metadata = future.get(timeout=10)
        print(f"Сообщение отправлено в {record_metadata.topic} раздел {record_metadata.partition} смещение {record_metadata.offset}")
    except Exception as e:
        print(f"Ошибка при отправке сообщения: {e}")
```

### Тестирование
Для тестирования обёртки Kafka Producer были написаны тесты с использованием `unittest` и `unittest.mock`. Тесты проверяют корректность отправки сообщений и закрытия соединения.

Пример теста для отправки сообщения:
```py
@patch('src.utils.kafka_producer_wrapper.KafkaProducer')
def test_send_message(self, MockKafkaProducer):
    # Настройка мока
    mock_producer = MockKafkaProducer.return_value
    mock_future = MagicMock()
    mock_producer.send.return_value = mock_future
    mock_future.get.return_value = MagicMock(topic='test_topic', partition=0, offset=0)

    # Создание экземпляра KafkaProducerWrapper
    producer_wrapper = KafkaProducerWrapper(bootstrap_servers=['localhost:9092'], topic='test_topic')

    # Отправка сообщения
    message = {'key': 'value'}
    producer_wrapper.send_message(message)

    # Проверка вызовов
    mock_producer.send.assert_called_once_with('test_topic', message)
    mock_future.get.assert_called_once_with(timeout=10)
```

## Проблемы и их решение
В процессе разработки возникли следующие проблемы:

1. Проблемы с импортом модулей: Для корректного импорта модулей использовались относительные пути и настройка переменной окружения PYTHONPATH.
2. Настройка Kafka и Zookeeper: Для поднятия Kafka и Zookeeper использовался Docker Compose, что позволило быстро настроить окружение для тестирования.
3. Использование API AirSim: Возникли затруднения с использованием API для программного управления летательным аппаратом в симуляции. Был проведён анализ документации и примеров кода, что помогло решить проблему.
## Дальнейшие шаги
1. Оптимизация кода: Провести рефакторинг кода для улучшения читаемости и производительности.
2. Расширение функционала: Добавить новые функции для более сложного управления квадрокоптером и обработки данных.
3. Документация: Создать подробную документацию по использованию и настройке системы.
4. Интеграция с другими системами: Рассмотреть возможность интеграции с другими системами для анализа и визуализации данных.
## Заключение
Разработанная система для управления квадрокоптером и отправки данных в Kafka показала свою работоспособность и потенциал для дальнейшего развития. Несмотря на возникшие трудности, удалось успешно реализовать основные функции и провести тестирование. В дальнейшем планируется расширение функционала и улучшение системы.

`trajectory_generator.py` - программа для управления квадрокоптером через API AirSim. 

`kafka_producer_wrapper.py` - обёртка для Kafka Producer. 

`test_kafka_producer_wrapper.py` - тесты для проверки корректности работы Kafka Producer. 